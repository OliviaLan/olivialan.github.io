<!DOCTYPE html>
<meta charset="utf-8">
<style>
    .container {
        width: 950px;
        height: 345px;
        float: left;
        clear: right;
        margin-top: 20px;
        margin-left: 9px;
    }
    
    .button {
        position: absolute;
        background-color: #ccc;
        padding: 10px 10px 10px 10px;
    }
    
    #button1 {
        top: 340px;
        left: 20px;
    }
    
    #button2 {
        top: 340px;
        left: 100px;
    }
    
    .axis path {
        display: none;
    }
    
    .axis text {
        font-family: sans-serif;
        font-size: 10.5px;
    }
    
    .axis line {
        fill: none;
        stroke: lightgray;
        stroke-width: 1px;
        shape-rendering: crispEdges;
    }
    
    .line {
        fill: none;
        stroke: RGB(168, 192, 215);
        stroke-width: 3.5px;
    }
</style>

<body>


    <div class="container" id="GDP"></div>
    <div id="button1" class="button">Next</div>
    <div id="button2" class="button">Restart</div>

    <script src="https://d3js.org/d3.v5.min.js"></script>

    <!-- <script src="https://d3js.org/d3.v3.min.js"></script> -->
    <script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>

    <script>
        //Global variables
        var margin = {
                top: 25,
                bottom: 20,
                left: 20,
                right: 10
            },
            height = 245 - margin.top - margin.bottom,
            width = 950 - margin.left - margin.right,
            parseDate = d3.timeParse("%m/%d/%Y"),
            formatFourDigitYear = d3.timeParse("%Y");

        var dataGDP = [{
            date: "1/1/2008",
            GDPreal: "2.8"
        }, {
            date: "4/1/2008",
            GDPreal: "0.6"
        }, {
            date: "7/1/2008",
            GDPreal: "2.1"
        }, {
            date: "10/1/2008",
            GDPreal: "4.3"
        }, {
            date: "1/1/2009",
            GDPreal: "6.8",
            GDPforecast: "1.63"
        }, {
            date: "4/1/2009",
            GDPreal: "6.3",
            GDPforecast: "1.40"
        }, {
            date: "7/1/2009",
            GDPreal: "5",
            GDPforecast: "0.56"
        }, {
            date: "10/1/2009",
            GDPreal: "2.5",
            GDPforecast: "-0.29"
        }, {
            date: "1/1/2010",
            GDPreal: "0.5",
            GDPforecast: "-0.42"
        }, {
            date: "4/1/2010",
            GDPreal: "2",
            GDPforecast: "-0.25"
        }, {
            date: "7/1/2010",
            GDPreal: "2.4",
            GDPforecast: "1.67"
        }, {
            date: "10/1/2010",
            GDPreal: "1.8",
            GDPforecast: "2.94"
        }, {
            date: "1/1/2011",
            GDPreal: "1.7",
            GDPforecast: "2.94"
        }, {
            date: "4/1/2011",
            GDPreal: "0.8",
            GDPforecast: "2.97"
        }, {
            date: "7/1/2011",
            GDPreal: "1.0",
            GDPforecast: "2.49"
        }, {
            date: "10/1/2011",
            GDPreal: "1.1",
            GDPforecast: "2.42"
        }, {
            date: "1/1/2012",
            GDPreal: "0.6",
            GDPforecast: "2.56"
        }, {
            date: "4/1/2012",
            GDPreal: "10",
            GDPforecast: "2.49"
        }, {
            date: "7/1/2012",
            GDPreal: "0.1",
            GDPforecast: "1.94"
        }, {
            date: "10/1/2012",
            GDPreal: "10",
            GDPforecast: "1.21"
        }, {
            date: "1/1/2013",
            GDPreal: "33",
            GDPforecast: "2.23"
        }, {
            date: "4/1/2013",
            GDPreal: "55",
            GDPforecast: "2.51"
        }];

        dataGDP.forEach(function(d) {
            d.date = parseDate(d.date);
            d.GDPreal = +d.GDPreal;
        });

        var xScaleGDP = d3.scaleTime()
            .range([0, width]);

        var yScaleGDP = d3.scaleLinear()
            .range([height, 0]);

        //先按前五年的范围画坐标轴
        xScaleGDP.domain(d3.extent(dataGDP.slice(10, 24), function(d) {
            return d.date;
        }));
        yScaleGDP.domain([0, d3.max(dataGDP.slice(10, 24), function(d) {
            return d.GDPreal;
        })]);


        var canvasGDP = d3.select("#GDP").append("svg")
            .attr("width", width)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        canvasGDP.append("g")
            .attr("class", "xAxis")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(xScaleGDP));

        canvasGDP.append("g")
            .attr("class", "yAxis")
            .attr("transform", "translate(0,0)")
            .call(d3.axisLeft(yScaleGDP));

        var realGDPline = canvasGDP.append("line")
            .attr("class", "line")
            .style("stroke", "transparent");

        var focus = canvasGDP.append("g")
            .attr("fill", "orange");

        focus.append("circle")
            .attr("r", 5);

        focus.append("text")
            .attr("x", 0)
            .attr("dy", "-0.7em");


        var counter = 10;
        // var counter = 0;

        // Extra points which are not visible yet stack up on the of the line on the last point.
        var lineGen = d3.line()
            .x(function(d, i) {
                if (counter >= 10) {
                    if (i < 10) return xScaleGDP(dataGDP[10].date)
                    else if (10 <= i && i <= counter) return xScaleGDP(d.date)
                    else if (i > counter) return xScaleGDP(dataGDP[counter].date)
                }
                // debugger;
                // return xScaleGDP(i <= counter ? d.date : dataGDP[counter].date);
                else if (counter < 10) {
                    if (i <= counter) return xScaleGDP(dataGDP[counter].date)
                    else return xScaleGDP(d.date);
                }
            })
            .y(function(d, i) {
                // return yScaleGDP(i <= counter ? d.GDPreal : dataGDP[counter].GDPreal);
                if (counter >= 10) {
                    if (i < 10) return yScaleGDP(dataGDP[10].GDPreal)
                    else if (10 <= i && i <= counter) return yScaleGDP(d.GDPreal)
                    else if (i > counter) return yScaleGDP(dataGDP[counter].GDPreal)
                } else if (counter < 10) {
                    if (i <= counter) return yScaleGDP(dataGDP[counter].GDPreal)
                    else return yScaleGDP(d.GDPreal);
                }
            })

        var pathLine = canvasGDP.append('path').datum(dataGDP)
            .attr('d', lineGen)
            .classed('line', true)

        function start() {

            counter = 10;

            realGDPline
                .attr("x1", xScaleGDP(dataGDP[counter].date))
                .attr("y1", yScaleGDP(dataGDP[counter].GDPreal))
                .attr("x2", xScaleGDP(dataGDP[counter].date))
                .attr("y2", yScaleGDP(dataGDP[counter].GDPreal));

            focus.attr("transform", "translate(" + xScaleGDP(dataGDP[counter].date) + "," + yScaleGDP(dataGDP[counter].GDPreal) + ")");

            focus.select("text").text(dataGDP[counter].GDPreal);

        }

        start();

        // for (counter = 1; counter < 22; counter++) {
        //     movefocus(counter)
        // }

        // for (counter = 20; counter > -1; counter--) {
        //     movefocus(counter)
        // }

        // counter = 0

        // for (counter = 1; counter < 22; counter++) {
        //     movefocus_forward(counter)
        // }


        for (counter = 11; counter < 22; counter++) {
            movefocus(counter)
        }

        counter = 10

        for (counter = 9; counter > -1; counter--) {
            movefocus_forward(counter)
        }




        function movefocus(counter) {

            // counter++;
            var d = dataGDP[counter]


            realGDPline
                .transition()
                .ease(d3.easeLinear)
                // .delay(counter * 500)
                // .delay(10000 - counter * 500)
                .delay((counter - 10) * 300)
                .duration(500)
                .attr("x2", xScaleGDP(dataGDP[1].date))
                .attr("y2", yScaleGDP(dataGDP[1].GDPreal));

            pathLine
                .transition()
                .ease(d3.easeLinear)
                .delay((counter - 10) * 300)
                .duration(500)
                // .delay(counter * 500)
                // .delay(10000 - counter * 500)
                .attr('d', lineGen)


            focus
                .transition()
                // .delay(counter * 500)
                // .delay(10000 - counter * 500)
                .delay((counter - 10) * 300)
                .duration(500)
                .attr("transform", "translate(" + xScaleGDP(d.date) + "," + yScaleGDP(d.GDPreal) + ")")
                .select("text")
                .text(dataGDP[counter].GDPreal);

            // focus
            //     .transition()
            //     .delay(counter * 500)
            //     .duration(500)

            xScaleGDP.domain(d3.extent(dataGDP.slice(10, 24), function(d) {
                return d.date;
            }));
            yScaleGDP.domain([0, d3.max(dataGDP.slice(10, 24), function(d) {
                return d.GDPreal;
            })]);

            canvasGDP.selectAll(".xAxis")
                .transition()
                // .delay(counter * 500)
                // .delay(10000 - counter * 500)
                .delay((counter - 10) * 500)
                .duration(490)
                .call(d3.axisBottom(xScaleGDP));

            // Add the y Axis
            canvasGDP.selectAll(".yAxis")
                .transition()
                // .delay(counter * 500)
                // .delay(10000 - counter * 500)
                .delay((counter - 10) * 500)
                .duration(490)
                .call(d3.axisLeft(yScaleGDP));


        }

        function movefocus_forward(counter) {

            // counter++;
            var d = dataGDP[counter]


            realGDPline
                .transition()
                .ease(d3.easeLinear)
                // .delay(10000 + counter * 500)
                .delay(5000 + (10 - counter) * 500)
                .duration(490)
                .attr("x2", xScaleGDP(dataGDP[1].date))
                .attr("y2", yScaleGDP(dataGDP[1].GDPreal));

            pathLine
                .transition()
                .ease(d3.easeLinear)
                .duration(490)
                .delay(5000 + (10 - counter) * 500)
                // .delay(10000 + counter * 500)
                .attr('d', lineGen)


            focus
                .transition()
                // .delay(10000 + counter * 500)
                .delay(5000 + (10 - counter) * 500)
                .duration(490)
                .attr("transform", "translate(" + xScaleGDP(d.date) + "," + yScaleGDP(d.GDPreal) + ")")
                .select("text")
                .text(dataGDP[counter].GDPreal);

            // focus
            //     .transition()
            //     .delay(counter * 500)
            //     .duration(500)


            xScaleGDP.domain(d3.extent(dataGDP.slice(counter, 24), function(d) {
                return d.date;
            }));
            yScaleGDP.domain([0, d3.max(dataGDP.slice(counter, 24), function(d) {
                return d.GDPreal;
            })]);

            canvasGDP.selectAll(".xAxis")
                .transition()
                // .delay(10000 + counter * 500)
                .delay(5000 + (10 - counter) * 500)
                .duration(490)
                .call(d3.axisBottom(xScaleGDP));

            // Add the y Axis
            canvasGDP.selectAll(".yAxis")
                .transition()
                // .delay(10000 + counter * 500)
                .delay(5000 + (10 - counter) * 500)
                .duration(490)
                .call(d3.axisLeft(yScaleGDP));


        }
    </script>